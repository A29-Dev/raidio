<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Raidio Live Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0c1117; --bg-soft:#0f1620; --panel:#0f1620; --panel2:#0b1420;
      --text:#d5deea; --muted:#9fb1c4; --border:#223247; --accent:#58a6ff;
      --chip:#10283f; --chip-br:#1e4263; --ok:#7ff0b3; --warn:#ffd166; --bad:#ff9b9b;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    }

    /* Top bar */
    .topbar{
      display:flex; align-items:center; gap:12px;
      padding:10px 14px; border-bottom:1px solid var(--border); background:#0b1320;
      position:sticky; top:0; z-index:10;
    }
    .app-title{ font-weight:600; color:var(--accent); }
    .spacer{ flex:1 }
    .btn{
      border:1px solid var(--border); background:#152238; color:#e7f2ff;
      padding:6px 10px; border-radius:8px; cursor:pointer;
    }
    .btn:hover{ filter:brightness(1.08); }
    .status{ font-size:12px; color:var(--muted); }

    /* Two-column layout */
    .wrap{
      display:grid; grid-template-columns: 1fr 2fr; gap:16px;
      padding:12px 14px; height:calc(100vh - 48px);
    }

    /* Transcript (left) */
    .panel{
      background:var(--panel); border:1px solid var(--border); border-radius:12px;
      display:flex; flex-direction:column; min-height:0;
    }
    .panel h2{
      margin:0; padding:10px 12px; border-bottom:1px solid var(--border); font-size:14px; color:var(--accent);
    }
    .transcript{
      padding:10px 12px; overflow:auto; flex:1; min-height:0;
    }
    .line{ margin:0 0 6px; white-space:pre-wrap; }
    .time{ color:#7b8aa0; margin-right:6px; font-variant-numeric:tabular-nums; }

    /* Info grid (right) */
    .info{
      background:var(--panel); border:1px solid var(--border); border-radius:12px;
      display:flex; flex-direction:column; min-height:0;
    }
    .info-body{
      padding:12px; overflow:auto; flex:1; min-height:0;
    }
    .card-grid{
      display:grid; grid-template-columns: repeat(auto-fill,minmax(240px,1fr));
      gap:12px; align-content:start;
    }

    /* Cards */
    .info-card{
      background:var(--panel2); border:1px solid var(--border); border-radius:12px;
      padding:12px; color:var(--text); box-shadow:0 1px 0 rgba(0,0,0,.4), 0 8px 24px rgba(8,15,25,.24);
      display:flex; flex-direction:column; min-height:170px;
    }
    .chips{ margin-bottom:8px; }
    .chip{
      display:inline-flex; align-items:center;
      font-size:11px; line-height:1; padding:6px 8px; border-radius:999px;
      border:1px solid var(--chip-br); color:#99c3f0; background:var(--chip);
    }
    .header{ display:flex; gap:10px; align-items:flex-start; margin-bottom:6px; }
    .thumb{
      width:64px; height:64px; border-radius:8px; object-fit:cover; background:#151e2a; border:1px solid #253247;
      flex:0 0 64px;
    }
    .title{ margin:0; font-size:15px; line-height:1.3; color:#8fc7ff; font-weight:600; }
    .extract{
      margin:6px 0 0; font-size:13px; color:#c2cee1;
      display:-webkit-box; -webkit-line-clamp:4; line-clamp:4; -webkit-box-orient:vertical; overflow:hidden;
    }
    .actions{ margin-top:auto; display:flex; gap:8px; }
    .a-btn{ text-decoration:none; border:1px solid var(--border); background:#17314a; color:#e7f2ff; padding:6px 10px; border-radius:8px; font-size:12px; }
    .a-btn:hover{ filter:brightness(1.1); }

    /* Heatmap chips row (optional) */
    .heat{ padding:8px 12px; border-top:1px solid var(--border); background:#0d1726; }
    .heat .chip{ margin-right:6px; margin-bottom:6px; }

    /* Debug tray */
    .debug{
      position:fixed; left:12px; right:12px; bottom:10px; z-index:15;
      background:rgba(0,0,0,.55); border:1px solid var(--border); color:#cfd8e6;
      border-radius:10px; padding:8px; font-size:12px; backdrop-filter: blur(5px);
      max-height:200px; overflow:auto;
    }

    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; height:auto; }
      .debug{ position:static; margin:10px 14px; }
    }
  </style>
</head>
<body>

  <!-- Top bar -->
  <div class="topbar">
    <div class="app-title">üéôÔ∏è Raidio Live Dashboard</div>
    <div class="spacer"></div>
    <button id="reloadBtn" class="btn">‚Üª Reload</button>
    <div id="status" class="status">Disconnected</div>
  </div>

  <!-- Two columns -->
  <div class="wrap">
    <!-- Left: Transcript -->
    <section class="panel">
      <h2>Transcript</h2>
      <div id="transcript" class="transcript"></div>
      <div id="heatmap" class="heat"></div>
    </section>

    <!-- Right: Info cards -->
    <section class="info">
      <h2>Live Info</h2>
      <div class="info-body">
        <div id="info" class="card-grid"></div>
      </div>
    </section>
  </div>

  <!-- Debug tray (optional) -->
  <div id="ws-debug" class="debug"></div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const transcriptDiv = document.getElementById("transcript");
    const infoGrid      = document.getElementById("info");
    const heatmapDiv    = document.getElementById("heatmap");
    const reloadBtn     = document.getElementById("reloadBtn");
    const statusEl      = document.getElementById("status");
    const dbg           = document.getElementById("ws-debug");

    const WS_URL = `ws://${location.hostname}:8000/live`;
    let ws, reconnectTimer = null;

    function log(s){ const d=document.createElement("div"); d.textContent=s; dbg.appendChild(d); dbg.scrollTop=dbg.scrollHeight; }
    function setStatus(s,c){ statusEl.textContent=s; statusEl.style.color=c||"#9fb1c4"; log(`[status] ${s}`); }
    function clearUI(){ transcriptDiv.innerHTML=""; infoGrid.innerHTML=""; heatmapDiv.innerHTML=""; }

    function appendTranscript(msg){
      const line = document.createElement("div");
      line.className = "line";
      const ts = document.createElement("span");
      ts.className = "time";
      ts.textContent = msg.t0 ? new Date(msg.t0).toLocaleTimeString() : (msg.time || "");
      const text = document.createElement("span");
      text.textContent = " " + (msg.text || "");
      line.append(ts, text);
      transcriptDiv.appendChild(line);
      transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
    }

    function renderHeat(list){
      heatmapDiv.innerHTML = "";
      (list||[]).forEach(w => {
        const chip = document.createElement("span");
        chip.className = "chip";
        chip.textContent = w;
        heatmapDiv.appendChild(chip);
      });
    }

    // ---- Card rendering (max 9; newest first)
    function pushInfoCard(data){
      // data: { entity, label, wiki?:{title,extract,url,thumbnail}, map?:{map_url,lat,lon} }
      const card = document.createElement("div");
      card.className = "info-card";

      const chips = document.createElement("div");
      chips.className = "chips";
      const lbl = document.createElement("span");
      lbl.className = "chip";
      lbl.textContent = (data.label || "ENT");
      chips.appendChild(lbl);

      const header = document.createElement("div");
      header.className = "header";

      const wiki = data.wiki || {};
      if (wiki.thumbnail){
        const img = document.createElement("img");
        img.className = "thumb"; img.src = wiki.thumbnail; img.alt = wiki.title || data.entity || "thumbnail";
        header.appendChild(img);
      }

      const twrap = document.createElement("div");
      const title = document.createElement("h3");
      title.className = "title";
      title.textContent = wiki.title || data.entity || "Info";
      const extract = document.createElement("p");
      extract.className = "extract";
      extract.textContent = wiki.extract || "No summary available.";
      twrap.appendChild(title); twrap.appendChild(extract);
      header.appendChild(twrap);

      const actions = document.createElement("div");
      actions.className = "actions";
      if (wiki.url){
        const a = document.createElement("a");
        a.href = wiki.url; a.target="_blank"; a.rel="noopener"; a.className="a-btn"; a.textContent="Open Wikipedia";
        actions.appendChild(a);
      }
      if (data.map && data.map.map_url){
        const m = document.createElement("a");
        m.href = data.map.map_url; m.target="_blank"; m.rel="noopener"; m.className="a-btn"; m.textContent="Open Map";
        actions.appendChild(m);
      }

      card.appendChild(chips);
      card.appendChild(header);
      card.appendChild(actions);

      infoGrid.prepend(card);
      while (infoGrid.children.length > 9) infoGrid.removeChild(infoGrid.lastElementChild);
    }

    // ---- WebSocket
    function connectWS(){
      try{ ws && ws.close(1000,"reconnect"); }catch{}
      if (reconnectTimer){ clearTimeout(reconnectTimer); reconnectTimer=null; }

      setStatus("Connecting‚Ä¶");
      ws = new WebSocket(WS_URL);
      ws.onopen = () => setStatus("Connected", "var(--ok)");
      ws.onclose = () => { setStatus("Reconnecting‚Ä¶", "var(--warn)"); reconnectTimer = setTimeout(connectWS, 2500); };
      ws.onerror = (e) => { setStatus("WebSocket error", "var(--bad)"); log(`[ws] error ${e?.message||""}`); };

      ws.onmessage = (ev) => {
        let m; try { m = JSON.parse(ev.data); } catch { m = { text:String(ev.data||"") }; }
        log(`[ws] ${ev.data}`);

        if (m.type === "transcript" || m.text){ appendTranscript(m); }
        if (m.type === "keywords"){ renderHeat(m.data||[]); }
        if (m.type === "info" && m.data){ pushInfoCard(m.data); }
      };
    }

    reloadBtn.addEventListener("click", () => clearUI());
    connectWS();
  });
  </script>
</body>
</html>
